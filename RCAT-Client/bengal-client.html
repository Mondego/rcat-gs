<html>
<head>
<style>
#textZone {
	font-size: 40px;
	background-color: lightblue;
	position: absolute;
	left: 50%;
	top: 50%;
	z-index: 1;
}
.player {
	width: 50px;
	height: 50px;
	background-color: #aaf;
	position: absolute;
	z-index: 2;
}
#avatar {
	width: 30px;
	height: 30px;
	background-color: #909;
	position: absolute;
	z-index: 3;
	top: 0;
	left: 0;
}
#chatLog {
	top: 0px;
	left: 200px;
	position: absolute;
	background-color: #dfd;
	z-index: 0;
}
#disconnect, #connect{
	top: 10px;
	right: 100px;
	position: absolute;
	z-index: 2;
}
</style>
<script src="http://code.jquery.com/jquery-1.5.js"></script>
<script src="http://www.ics.uci.edu/~tdebeauv/rCAT/json2.js"></script>
<script src="http://www.ics.uci.edu/~tdebeauv/rCAT/jshashtable-2.1.js"></script>

</head>

<body>

<p id="textZone"></p>

<div id="avatar"></div>

<div id="chatLog"></div>

<button id="disconnect" style="display:none">Disconnect</button>
<button id="connect">Connect</button>

<script type="text/javascript">
// ====================== CLIENT GAME STATE ==============

var usersTable = new Hashtable(); //will contain users' names and positions, indexed by name


// ============================ NETWORK =================


// print feedback in log window
function log(txt){
	$('#chatLog').append(txt);
}

var socket;

if(!("WebSocket" in window)){
	log("=== no web socket in this browser! ===");
}

function connect(){
	//var host = "ws://opensim.ics.uci.edu:81/websocket";	
	var host = "ws://128.195.4.46:81/websocket"; //opensim.ics.uci.edu
	//var host = "ws://chateau.ics.uci.edu:81/websocket"; 
	try {
		socket = new WebSocket(host);
		log('<dt>Socket Status:</dt><dd>'+socket.readyState+'</dd>');
		$('#connect').hide();
		$('#disconnect').show();
		socket.onopen = function(){
			log('<dt>Socket Status</dt><dd>'+socket.readyState+' (onopen); Host: '+ host +'</dd>');
		}
		socket.onmessage = function(msg){
			log('<dt>Received</dt><dd>'+msg.data +' (onmsg)</dd>');	
			var userPos = JSON.parse(msg.data);
			switch(userPos.Type) {
				case 2:
					receivePos(userPos.Data.Name, userPos.Data.Position.top, userPos.Data.Position.left);
					break;
				default:
					log('<dt>Error</dt><dd>Unknown msg.Type ('+ userPos.Type +') in connect().</dd>');
					break;
				}
		}
		socket.onclose = function(){
			log('<dt>Socket Status</dt> <dd> (onclose) '+socket.readyState+' </dd>');
		}
	} catch(exception) {
		log('<dt>Error:</dt> <dd>'+exception+'</dd>');
	}
}

function disconnect() {
	socket.close();
	log('<dt>Socket Status:</dt><dd>'+socket.readyState+'</dd>');
	log("Connection closed.");
	$('#disconnect').hide();
	$('#connect').show();
}

// when I receive a position from the server
function receivePos(name, top, left){
	
	if(usersTable.containsKey(name)) { //user was already displayed
		usersTable.get(name).top = top;
		usersTable.get(name).left = left;
		moveAvatar(name,top,left); //update graphics
	}
	else { //new user to draw
		var userCoords = {"top":top, "left":left}; //JSON storage
		usersTable.put(name, userCoords);
		createAvatar(name, top, left);
	}
}

// graphically move an avatar
function moveAvatar(name,top,left) { //el being the div to move
	var el = document.getElementById(name);
	var oldTop = el.offsetTop;
	var oldLeft = el.offsetLeft;
	el.style.top = top;
	el.style.left = left;
	//this could be more sophisticated, eg use jquery to make the div flow from previous offsetTop/Left to new top and left
}

// graphically create an avatar
function createAvatar(name, top, left) {
	el = document.createElement("div");
	el.id = name;
	el.setAttribute('class','player');
	el.innerHTML = name;
	el.style.top = top;
	el.style.left = left;
	document.body.appendChild(el);
}


// send my position to the server
function sendPos(){
	var avatar = document.getElementById("avatar");
	var pos = {
		"top": avatar.offsetTop,
		"left": avatar.offsetLeft 
		}; 
	var txt = JSON.stringify(pos);
	try{
		socket.send(txt);
		//log('Sent: '+txt)
	} catch(exception){
		log('Error: '+exception);
	}
}


// ==================== GRAPHICS ========================
var POS_SHIFT = 20; // the movement granularity


function doKeyPress(e) {
	var keyCode = e.keyCode ? e.keyCode : e.charCode; //firefox (charcode) vs others (keycode)
	var avatar = document.getElementById("avatar");
	//alert(keyCode);
	switch(keyCode) {
	case 37: //arrowleft
	case 97: //a
		text = "left";
		avatar.style.left = avatar.offsetLeft - POS_SHIFT;
		break;
	case 119: //w
	case 38: //arrowup
		text = "up";
		avatar.style.top = avatar.offsetTop - POS_SHIFT;
		break;
	case 39: //arrowright
	case 100: //d
		text = "right";
		avatar.style.left = avatar.offsetLeft + POS_SHIFT;
		break;
	case 40: //arrowdown
	case 115: //s
		avatar.style.top = avatar.offsetTop + POS_SHIFT;
		text = "down";
		break;
	default:
		text = String.fromCharCode(keyCode);
	}
	sendPos();
	$('#textZone').text(text);
};


document.onkeypress = doKeyPress;

$('#disconnect').bind('click', function(e) {
	//e.preventDefault();
	disconnect();
});

$('#connect').bind('click', function(e) {
	//e.preventDefault();
	connect();
});


</script>
</body>
</html>